<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="stylesheet.css" type="text/css" />
</head>
<body>
<h1 id="sharemind-web-application-tutorial">Sharemind Web Application Tutorial</h1>
<div id="TOC">
<ul>
<li><a href="#sharemind-web-application-tutorial">Sharemind Web Application Tutorial</a><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#application-walkthrough">Application Walkthrough</a><ul>
<li><a href="#gateway">Gateway</a></li>
<li><a href="#web-client">Web Client</a></li>
<li><a href="#secrec-script">SecreC Script</a></li>
</ul></li>
</ul></li>
</ul>
</div>
<h2 id="introduction">Introduction</h2>
<p>Sharemind Web Application Gateway is a Node.js server that allows web applications to utilise Sharemind's privacy preserving features. A single instance of the Web Gateway is hosted together with each Sharemind server, which relays data and queries between the web client and Sharemind server. This tutorial aims to teach how to create Sharemind web applications through a simple example application. In the example application, web clients send their geolocation data from the HTML5 Navigator API to the Sharemind servers in-secret-shared form. The servers store the data and calculate a histogram of distances to other clients using secure computation. Since computing with secret-shared values on Sharemind does not reveal the data that is being computed on, the server hosts do not learn the location of any client.</p>
<h2 id="setup">Setup</h2>
<p>To run the example application, you will need the Sharemind platform, Sharemind Web Client and Web Application Gateway APIs, Node.js of version 4 or above and NPM. Node.js can be downloaded and installed from <a href="https://nodejs.org/en/download/package-manager/">here</a>. In the <code>package.json</code> file, specify the location of the Web Client and Web Gateway NPM packages in your file system. Run <code>npm install</code> in the project root directory to install the necessary dependencies and copy them to the correct location. A Shell script is provided to compile and copy SecreC files. Edit the file paths in <code>deploy.sh</code> and add your Sharemind libraries folder to LD_LIBRARY_PATH with <code>export LD_LIBRARY_PATH=/PATH/TO/SHAREMIND/lib</code>. You can then deploy the SecreC script with <code>sh deploy.sh secrec/location-database.sc</code>. In the folder <code>gateway/</code> make sure you have the correct keys and that the configuration files are set up correctly for your Sharemind deployment. The server names, addresses and ports in the gateway configuration should match those in the Sharemind configuration files. Run <code>sh run_gateway.sh</code> to start the gateways. Open <code>webserver/index.html</code> in your browser.</p>
<h2 id="application-walkthrough">Application Walkthrough</h2>
<p>To make the tutorial easier to follow the example application is as bare bones as possible, containing no style sheets or animations. In addition, the code prioritises readability over performance or precision.</p>
<h3 id="gateway">Gateway</h3>
<p>The gateway is a Node.js application that runs on top of each Sharemind server. The gateway source code can be found in the folder <code>gateway/</code>. A shell script runs all three instances of the gateway with the right configurations. The gateways require each Sharemind server's public keys and the controller's private and public keys. For most use cases <code>gateway.js</code> should only be edited to add runnable SecreC scripts. The variable <code>scriptsInfoMap</code> contains an object for each script that can be called by the web client. Only scripts defined there can be run by clients. Note that a different <code>scriptsInfoMap</code> can be used for different clients.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Specify scripts that clients can run</span>
<span class="co">// Client requests running computation &#39;location-database&#39;, upon which the script &#39;location-database.sb&#39; is run</span>
<span class="kw">var</span> scriptsInfoMap <span class="op">=</span> <span class="op">{};</span>
scriptsInfoMap[<span class="st">&#39;location-database&#39;</span>] <span class="op">=</span> <span class="op">{</span>
  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;location-database.sb&#39;</span><span class="op">,</span>
  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;multi&#39;</span><span class="op">,</span> <span class="co">// &#39;multi&#39; means this script does MPC computations</span>
  <span class="dt">otherServerNames</span><span class="op">:</span> otherServerNames
<span class="op">};</span></code></pre></div>
<p>The function <code>gateway.handleNewClient</code> wraps the entire process negotiation protocol. This function specifies which SecreC scripts are allowed to be executed by the client. More detailed information about the process negotiation protocol and the rest of the Sharemind-Web-Gateway can be found in the documentation that is included with the API.</p>
<h3 id="web-client">Web Client</h3>
<p>The Web Client, in this case, is a single HTML file <code>webserver/index.html</code> that contains the web page and JavaScript. The HTML body contains a single button that executes the function <code>getLocation()</code> and a div that will contain the returned histogram.</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;in&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;button&quot;</span><span class="ot"> value=</span><span class="st">&quot;Send&quot;</span><span class="ot"> onclick=</span><span class="st">&quot;getLocation()&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;out&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/div&gt;</span>
<span class="kw">&lt;/body&gt;</span></code></pre></div>
<p>In the head of the HTML file, three external javascript modules are included: socket.io, jsbn and sharemind-web-client. The location of these modules is specified in <code>package.json</code>.</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>HTML<span class="dt">&gt;</span>
<span class="kw">&lt;html&gt;</span>
<span class="kw">&lt;head&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;js/ext/socket.io.min.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;js/ext/jsbn.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;js/ext/sharemind-web-client.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    ...
<span class="kw">&lt;/head&gt;</span></code></pre></div>
<p>The embedded JavaScipt contains functions to get location data and send it to the servers and variables to support those actions. The list <code>hosts</code> contains a string of the IP address and port for each gateway. Because this example application is meant to be run on the same device as the gateways, the IP addresses are <code>localhost</code>. The variables <code>pub</code> and <code>priv</code> are Sharemind protection domains that are used to create variables of those domains.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> hosts <span class="op">=</span> [
            <span class="st">&quot;http://localhost:8081&quot;</span><span class="op">,</span>
            <span class="st">&quot;http://localhost:8082&quot;</span><span class="op">,</span>
            <span class="st">&quot;http://localhost:8083&quot;</span>
        ]<span class="op">;</span>
        <span class="kw">var</span> gatewayConnection <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
        <span class="kw">var</span> pub <span class="op">=</span> <span class="va">sm</span>.<span class="va">types</span>.<span class="at">base</span><span class="op">;</span>
        <span class="kw">var</span> priv <span class="op">=</span> <span class="va">sm</span>.<span class="va">types</span>.<span class="at">shared3p</span><span class="op">;</span></code></pre></div>
<p>In sharemind, all data are stored as arrays, behind the scenes scalar values are just arrays with a single element. Because of this, the Sharemind-Web-Client only allows the creation of arrays. The available data types are:</p>
<ul>
<li>IntNArray</li>
<li>UintNArray</li>
<li>XorUintNArray</li>
<li>Float32Array</li>
<li>Float64Array</li>
</ul>
<p>where N is 8, 16, 32 or 64. Variable length strings are only available as public variables, for private bound length strings XorUint8Array is used internally with a public Uint64 that specifies the string bound.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">//declare a public array with 3 elements</span>
<span class="kw">var</span> public_value <span class="op">=</span> <span class="kw">new</span> <span class="va">pub</span>.<span class="at">Int64Array</span>(<span class="dv">3</span>)<span class="op">;</span>
<span class="co">//set the first element to 900</span>
<span class="va">public_value</span>.<span class="at">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">900</span>)<span class="op">;</span>

<span class="co">//secret share the public array</span>
<span class="kw">var</span> private_value <span class="op">=</span> <span class="kw">new</span> <span class="va">priv</span>.<span class="at">Int64Array</span>(public_value)</code></pre></div>
<p>The function <code>getLocation()</code> is called when the user presses the <code>Send</code> button. This function asks the user for permission to access their location data and once it has received it, calls <code>sendLocation()</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">getLocation</span>() <span class="op">{</span>
            <span class="co">// this uses HTML5 navigator api, in Chrome version &gt; 49 https is requiered</span>
            <span class="cf">if</span> (<span class="va">navigator</span>.<span class="at">geolocation</span>) <span class="op">{</span>
                <span class="va">navigator</span>.<span class="va">geolocation</span>.<span class="at">getCurrentPosition</span>(sendLocation)<span class="op">;</span>
            <span class="op">}</span>
        <span class="op">}</span></code></pre></div>
<p>A new gateway connection object is created with <code>new sm.client.GatewayConnection(hosts)</code>, besides a list of gateway locations, Socket.io options and a callback function can be given as optional arguments. The connection is opened with <code>gatewayConnection.openConnection(callback(error, serverInfos, prngSeed));</code>. A callback function is called once the connection is established. In the callback function errors are logged, if a pseudorandom number generator doesn't exist, it is created, public and private variables are declared and a SecreC script is run. The function <code>gatewayConnection.runMpcComputation(script-name, arguments, callback(err, results))</code> runs the specified script on the Sharemind servers with the given arguments and calls the callback function once the script has finished. The script must be declared in <code>scriptsInfoMap</code> in <code>gateway.js</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">sendLocation</span>(pos) <span class="op">{</span>
            <span class="kw">var</span> longitude <span class="op">=</span> <span class="at">toRadians</span>(<span class="at">parseFloat</span>(<span class="va">pos</span>.<span class="va">coords</span>.<span class="at">longitude</span>))<span class="op">;</span>
            <span class="kw">var</span> latitude <span class="op">=</span> <span class="at">toRadians</span>(<span class="at">parseFloat</span>(<span class="va">pos</span>.<span class="va">coords</span>.<span class="at">latitude</span>))<span class="op">;</span>

            <span class="co">// write location data to console</span>
            <span class="va">console</span>.<span class="at">log</span>(longitude)<span class="op">;</span>
            <span class="va">console</span>.<span class="at">log</span>(latitude)<span class="op">;</span>

            <span class="co">// create a new gateway connection</span>
            gatewayConnection <span class="op">=</span> <span class="kw">new</span> <span class="va">sm</span>.<span class="va">client</span>.<span class="at">GatewayConnection</span>(hosts)<span class="op">;</span>

            <span class="co">// connect to gateways</span>
            <span class="co">// once connections are established, secret share the data and run script</span>
            <span class="va">gatewayConnection</span>.<span class="at">openConnection</span>(<span class="kw">function</span>(err<span class="op">,</span> serverInfos<span class="op">,</span> prngSeed) <span class="op">{</span>
                <span class="co">// if an error accures</span>
                <span class="cf">if</span> (err) <span class="op">{</span>
                    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;[ERROR] : &quot;</span> <span class="op">+</span> <span class="va">err</span>.<span class="at">message</span>)<span class="op">;</span>
                <span class="op">}</span>

                <span class="co">// if a pseudorandom number generator doesn&#39;t exist, create one from the seed</span>
                <span class="cf">if</span> (<span class="op">!</span><span class="va">sm</span>.<span class="va">prng</span>.<span class="at">instance</span>) <span class="op">{</span>
                    <span class="va">sm</span>.<span class="va">prng</span>.<span class="at">init</span>(prngSeed)<span class="op">;</span>
                <span class="op">}</span>

                <span class="co">// create a public float64 array of size two and insert values into it</span>
                <span class="kw">var</span> pub_value <span class="op">=</span> <span class="kw">new</span> <span class="va">pub</span>.<span class="at">Float64Array</span>(<span class="dv">2</span>)<span class="op">;</span>
                <span class="va">pub_value</span>.<span class="at">set</span>(<span class="dv">0</span><span class="op">,</span> latitude)<span class="op">;</span>
                <span class="va">pub_value</span>.<span class="at">set</span>(<span class="dv">1</span><span class="op">,</span> longitude)<span class="op">;</span>

                <span class="co">// create a private float64 array from the public array</span>
                <span class="kw">var</span> private_value <span class="op">=</span> <span class="kw">new</span> <span class="va">priv</span>.<span class="at">Float64Array</span>(pub_value)<span class="op">;</span>
                <span class="kw">var</span> args <span class="op">=</span> <span class="op">{};</span>  <span class="co">// object holding arguments given to the script</span>

                <span class="co">// insert private value into args, the key string is used in the script to get the value</span>
                args[<span class="st">&quot;location&quot;</span>] <span class="op">=</span> private_value<span class="op">;</span>

                <span class="co">// run script &quot;location-database&quot;, after completion retrieve and format the result</span>
                <span class="va">gatewayConnection</span>.<span class="at">runMpcComputation</span>(<span class="st">&quot;location-database&quot;</span><span class="op">,</span> args<span class="op">,</span> <span class="kw">function</span>(err<span class="op">,</span> result) <span class="op">{</span>
                    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Ran script&quot;</span>)<span class="op">;</span>
                    <span class="kw">var</span> res <span class="op">=</span> result[<span class="st">&quot;hist&quot;</span>]<span class="op">;</span>  <span class="co">// the result is a public array of uint64</span>

                    <span class="co">// format the results</span>
                    <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;out&quot;</span>).<span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&quot;&lt;p&gt;&quot;</span> <span class="op">+</span>
                        <span class="st">&quot;People closer then 500m : &quot;</span> <span class="op">+</span> <span class="va">res</span>.<span class="at">get</span>(<span class="dv">0</span>) <span class="op">+</span> <span class="st">&quot;&lt;br&gt;&quot;</span> <span class="op">+</span>
                        <span class="st">&quot;People closer then 1km  : &quot;</span> <span class="op">+</span> <span class="va">res</span>.<span class="at">get</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">&quot;&lt;br&gt;&quot;</span> <span class="op">+</span>
                        <span class="st">&quot;People closer then 2km  : &quot;</span> <span class="op">+</span> <span class="va">res</span>.<span class="at">get</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">&quot;&lt;br&gt;&quot;</span> <span class="op">+</span>
                        <span class="st">&quot;People closer then 5km  : &quot;</span> <span class="op">+</span> <span class="va">res</span>.<span class="at">get</span>(<span class="dv">3</span>) <span class="op">+</span> <span class="st">&quot;&lt;br&gt;&quot;</span> <span class="op">+</span>
                        <span class="st">&quot;People further then 5km : &quot;</span> <span class="op">+</span> <span class="va">res</span>.<span class="at">get</span>(<span class="dv">4</span>) <span class="op">+</span> <span class="st">&quot;&lt;br&gt;&quot;</span> <span class="op">+</span>
                        <span class="st">&quot;&lt;/p&gt;&quot;</span><span class="op">;</span>
                <span class="op">}</span>)
            <span class="op">}</span>)<span class="op">;</span>
        <span class="op">}</span></code></pre></div>
<h3 id="secrec-script">SecreC Script</h3>
<p>SecreC is a domain specific language for Sharemind that is designed to look like C. The main difference between SecreC and C is that in SecreC every variable has a protection domain that can be either public or private. Variables that are private are secret shared and computations on those variables are done on the Sharemind servers. Detailed information about the SecreC language can be found in the <a href="http://sharemind-sdk.github.io/stdlib/reference/modules.html">official documentation</a>. When a SecreC script is run the <code>void main()</code> function is called. Inside the main function of the example application, a database connection is opened, arguments are parsed, the result is calculated and published.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// main function executed when the script is called</span>
<span class="dt">void</span> main() {
    <span class="kw">public</span> string ds = <span class="st">&quot;DS1&quot;</span>;  <span class="co">// datasource that is defined in the sharemind configuration</span>
    <span class="kw">public</span> string table = <span class="st">&quot;location-data&quot;</span>;  <span class="co">// name of the table where the values will be stored</span>

    tdbOpenConnection(ds);

    createTable(ds, table);  <span class="co">// if the table doesn&#39;t exist yet, create it </span>

    <span class="co">// retrieve the client&#39;s location data and store it in secret shared double precision floats</span>
    pd_shared3p float64[[<span class="kw">1</span>]] location = argument(<span class="st">&quot;location&quot;</span>);
    pd_shared3p float64 latitude = location[<span class="dv">0</span>];
    pd_shared3p float64 longitude = location[<span class="dv">1</span>];

    <span class="co">// calculate the distance between the client&#39;s location and all locations stored in the database</span>
    <span class="co">// then create a histogram out of it</span>
    pd_shared3p <span class="dt">uint</span>[[<span class="kw">1</span>]] hist = calculateDistanceHistogram(ds, table, latitude, longitude);

    <span class="co">// publish the histogram so that it can be retrieved by the client</span>
    publish(<span class="st">&quot;hist&quot;</span>, hist);

    <span class="co">// store the client&#39;s location data in the database</span>
    storeValue(ds, table, latitude, longitude);
    tdbCloseConnection(ds);  <span class="co">// close connection to the datasource, just in case it isn&#39;t done automatically</span>
}</code></pre></div>
<p>The script imports a few SecreC Standard Library modules, these should come with the Sharemind platform. Also, a privacy domain named <code>pd_shared3p</code> is declared of the kind <code>shared3p</code>. This means that variables of that domain are shared between three Sharemind servers and are secure in the presence of one passively corrupted server.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// import modules from the secrec standard library</span>
import shared3p;                    <span class="co">// contains secret shared data types and regular functions like sin() and sqrt()</span>
import stdlib;                      <span class="co">// contains standard functions like publish() and print()</span>
import table_database;              <span class="co">// for creating table databases</span>
import shared3p_table_database;     <span class="co">// for inserting and retrieving secret shared values from databases</span>

domain pd_shared3p shared3p;  <span class="co">// create a protection domain of kind shared3p</span></code></pre></div>
<p>The <code>createTable()</code> function, which is called in the <code>main()</code> function, constructs a table database if one doesn't already exist. To create a table a vector map (vmap) must be specified. A vector map is similar to a JavaScript object or a Python dictionary as it stores data in key/value pairs, but in SecreC all values are stored as arrays and thus can have multiple elements. This vmap contains the header of the table with information about each column. In the example application, a name and data type are provided, a column index can also be given. Once the table has been constructed, the vmap is deleted.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// if it doesn&#39;t exist yet, create a table database for location data</span>
<span class="dt">void</span> createTable(string datasource, string table) {
    <span class="kw">if</span> (!tdbTableExists(datasource, table)) {
        pd_shared3p float64 nfloat64;  <span class="co">// used to indicate type of float64 in params</span>

        <span class="co">// create a vector map for the paramaters (paramater map) </span>
        <span class="co">// a parameter map is used to create the header of a table</span>
        uint64 params = tdbVmapNew();

        <span class="co">// candidateId</span>
        tdbVmapAddType(params, <span class="st">&quot;types&quot;</span>, nfloat64);
        tdbVmapAddString(params, <span class="st">&quot;names&quot;</span>, <span class="st">&quot;latitude&quot;</span>);

        <span class="co">// vote</span>
        tdbVmapAddType(params, <span class="st">&quot;types&quot;</span>, nfloat64);
        tdbVmapAddString(params, <span class="st">&quot;names&quot;</span>, <span class="st">&quot;longitude&quot;</span>);

        <span class="co">// create the table</span>
        tdbTableCreate(datasource, table, params);

        <span class="co">// the resulting table looks like this:</span>
        <span class="co">//</span>
        <span class="co">//        ---------------------------------------------</span>
        <span class="co">// names: |          &quot;latitude&quot; |         &quot;longitude&quot; |</span>
        <span class="co">// types: | pd_shared3p float64 | pd_shared3p float64 |</span>
        <span class="co">//        ---------------------------------------------</span>
        <span class="co">//  data: |    coord in radians |    coord in radians |</span>
        <span class="co">//        |                   * |                   * |</span>
        <span class="co">//        |                   * |                   * |</span>
        <span class="co">//        |                   * |                   * |</span>
        <span class="co">//        ---------------------------------------------</span>

        <span class="co">// clean up the parameters</span>
        tdbVmapDelete(params);
    }
}</code></pre></div>
<p>The function <code>storeValue()</code> creates a vmap of values and adds them to the table database. Values must be inserted with the key <code>&quot;values&quot;</code>.If you wish to add more than one row of values, <code>tdbVmapAddBatch()</code> must be called between rows. Call <code>tdbInsertRow()</code> to add the vmap to the table. If every column in the table database has the same data type, a regular array with one element for every column can be used instead of a vmap.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// add a row to the table database</span>
<span class="kw">template</span>&lt;domain D : shared3p&gt;
<span class="dt">void</span> storeValue(string datasource,
                string table,
                D float64 latitude,
                D float64 longitude) {

    uint64 params = tdbVmapNew();  <span class="co">// create a vector map containing the data</span>

    <span class="co">// data is added in batches, one batch is one row</span>
    <span class="co">// if you add multiple rows, you need to create a new batch between rows</span>
    <span class="co">// here only one row is added, so creating a new batch is not necessary</span>
    tdbVmapAddValue(params, <span class="st">&quot;values&quot;</span>, latitude);
    tdbVmapAddValue(params, <span class="st">&quot;values&quot;</span>, longitude);

    tdbInsertRow(datasource, table, params);  <span class="co">// insert the vmap into the table database</span>
}</code></pre></div>
<p>In the function <code>calculateDistanceHistogram()</code> an approximation is used to calculate the distance between two pairs of coordinates. Two private, one-dimensional float64 arrays are created to store the two columns of the table database. A public uint64 is created to store the number of rows in the table. Private calculations are done on the inputs and database columns and the results are saved in private arrays. Comparison results for the histogram are stored in private boolean arrays. The function returns an array of type uint64 that contains the sums of the boolean arrays. Because this function declares many arrays with the same size as the database, it ends up allocating a lot of memory. In real life applications, where possible, standard library functions should be used because of their optimised memory usage.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// calculate the distances as if the earth was flat, this is accurate enough for this application</span>
<span class="co">// https://en.wikipedia.org/wiki/Geographical_distance#Spherical_Earth_projected_to_a_plane</span>
<span class="kw">template</span>&lt;domain D : shared3p&gt;
D <span class="dt">uint</span>[[<span class="kw">1</span>]] calculateDistanceHistogram(string datasource,
                                     string table,
                                     D float64 lat1,
                                     D float64 long1) {

    <span class="co">// read previously stored location data from the database, store it in two arrays</span>
    pd_shared3p float64[[<span class="kw">1</span>]] lat2 = tdbReadColumn(datasource, table, <span class="st">&quot;latitude&quot;</span>);
    pd_shared3p float64[[<span class="kw">1</span>]] long2 = tdbReadColumn(datasource, table, <span class="st">&quot;longitude&quot;</span>);

    <span class="dt">uint</span> k = size(lat2);  <span class="co">// how many locations are stored in the database, public value</span>
    float64 R = <span class="dv">6371</span>;  <span class="co">// Earth&#39;s mean radius in kilometers</span>

    <span class="co">// the calculations are done on arrays so that all distances can be calculated in parallel</span>
    <span class="co">// this is more efficient then doing it in a for loop</span>

    <span class="co">// calculate the distance between the client&#39;s coordinates and all other coordinates</span>
    pd_shared3p float64[[<span class="kw">1</span>]] d_lat = lat2 - lat1;
    pd_shared3p float64[[<span class="kw">1</span>]] d_long = long2 - long1;

    <span class="co">// declare some arrays to store calculation results</span>
    pd_shared3p float64[[<span class="kw">1</span>]] a(k);
    pd_shared3p float64[[<span class="kw">1</span>]] b(k);
    pd_shared3p float64[[<span class="kw">1</span>]] c(k);
    pd_shared3p float64[[<span class="kw">1</span>]] dist(k);

    <span class="co">// calculate the distances with the formula given in the wikipedia article</span>
    a = d_lat * d_lat;
    b = (lat1 + lat2) / <span class="dv">2</span>;
    c = cos(b) * d_long;
    dist = R * sqrt(a + c * c);

    <span class="co">// store boolean arrays of comparisons</span>
    pd_shared3p <span class="dt">bool</span>[[<span class="kw">1</span>]] l05 = dist &lt; <span class="fl">0.5</span>;                 <span class="co">// distance less then 0.5 km</span>
    pd_shared3p <span class="dt">bool</span>[[<span class="kw">1</span>]] l1 = (dist &lt; <span class="dv">1</span>) == (dist &gt; <span class="fl">0.5</span>);  <span class="co">// distance less then 1.0 km</span>
    pd_shared3p <span class="dt">bool</span>[[<span class="kw">1</span>]] l2 = (dist &lt; <span class="dv">2</span>) == (dist &gt; <span class="fl">1.0</span>);  <span class="co">// distance less then 2.0 km</span>
    pd_shared3p <span class="dt">bool</span>[[<span class="kw">1</span>]] l5 = (dist &lt; <span class="dv">5</span>) == (dist &gt; <span class="fl">2.0</span>);  <span class="co">// distance less then 5.0 km</span>
    pd_shared3p <span class="dt">bool</span>[[<span class="kw">1</span>]] m5 = dist &gt; <span class="dv">5</span>;                    <span class="co">// distance greater then 5.0 km</span>

    <span class="co">// sum of a boolean array returns an unsigned integer</span>
    <span class="co">// create an array from the sums of boolean arrays</span>
    <span class="kw">return</span> {sum(l05), sum(l1), sum(l2), sum(l5), sum(m5)};
}</code></pre></div>
<p>SecreC supports C++ style <a href="http://sharemind-sdk.github.io/stdlib/reference/templates.html">templates</a> that allow the creation of domain type polymorphic functions. In the example application, templates are used to make functions that accept inputs of any shared3p protection domain.</p>
</body>
</html>
